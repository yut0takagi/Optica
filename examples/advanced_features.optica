# =============================================================================
# Optica v0.2 - Advanced Features Demo
# =============================================================================
# このファイルは新しい言語機能のサンプルです

model "Advanced Optimization Model"

# -----------------------------------------------------------------------------
# 集合定義
# -----------------------------------------------------------------------------
set ITEMS = {"A", "B", "C", "D", "E"}
set WAREHOUSES = {"W1", "W2"}
set CUSTOMERS = 1..5
set PERIODS = 1..3

# -----------------------------------------------------------------------------
# データブロック - モデル内でデータを直接定義
# -----------------------------------------------------------------------------
data:
    # スカラーパラメータ
    capacity = 100
    budget = 5000
    
    # インデックス付きパラメータ
    cost[A] = 10
    cost[B] = 20
    cost[C] = 15
    cost[D] = 25
    cost[E] = 30
    
    # 2次元データ
    distance[W1, 1] = 5.0
    distance[W1, 2] = 8.0
    distance[W1, 3] = 12.0
    distance[W2, 1] = 7.0
    distance[W2, 2] = 3.0
    distance[W2, 3] = 9.0
    
    # 需要データ
    demand[1] = 50
    demand[2] = 30
    demand[3] = 45
    demand[4] = 20
    demand[5] = 35

# -----------------------------------------------------------------------------
# 外部パラメータ（JSONファイルから読み込み可能）
# -----------------------------------------------------------------------------
param weight[ITEMS] real
param value[ITEMS] real
param supply[WAREHOUSES] int

# -----------------------------------------------------------------------------
# 変数定義
# -----------------------------------------------------------------------------
var x[ITEMS] binary                    # アイテム選択
var y[WAREHOUSES, CUSTOMERS] binary    # 配送割り当て
var z[ITEMS, PERIODS] int              # 期間ごとの生産量

# -----------------------------------------------------------------------------
# 関数定義（再利用可能な式）
# -----------------------------------------------------------------------------
def total_cost(i) -> real:
    cost[i] * weight[i]

def shipping_cost(w, c) -> real:
    distance[w, c] * 2.5

# -----------------------------------------------------------------------------
# 目的関数
# -----------------------------------------------------------------------------
maximize profit:
    sum(i in ITEMS) value[i] * x[i] - sum(i in ITEMS) total_cost(i) * x[i]

# -----------------------------------------------------------------------------
# 制約条件
# -----------------------------------------------------------------------------
subject to:

    # 基本制約
    weight_limit:
        sum(i in ITEMS) weight[i] * x[i] <= capacity

    # 予算制約
    budget_constraint:
        sum(i in ITEMS) cost[i] * x[i] <= budget

    # 条件付き制約（if-then）
    conditional_supply:
        forall w in WAREHOUSES, c in CUSTOMERS:
            if distance[w, c] <= 10 then y[w, c] <= 1 else y[w, c] == 0

    # 全顧客への配送
    serve_all_customers:
        forall c in CUSTOMERS:
            sum(w in WAREHOUSES) y[w, c] >= 1

    # 倉庫キャパシティ
    warehouse_capacity:
        forall w in WAREHOUSES:
            sum(c in CUSTOMERS) demand[c] * y[w, c] <= supply[w]

    # 期間間の連続性
    production_continuity:
        forall i in ITEMS, t in 2..3:
            z[i, t] >= z[i, t-1] * 0.8

    # 論理制約（アイテムAを選ぶならBも選ぶ）
    item_dependency:
        x[A] <= x[B]

    # 最低選択数
    min_selection:
        sum(i in ITEMS) x[i] >= 2

